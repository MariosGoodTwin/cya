#!/bin/bash

# Find where we're running from
CYA_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../" && pwd )"

# Refuse to run if $HOME is not set
[[ -z $HOME ]] && { echo "\$HOME environmental variable is not set; please set it and try again."; exit -1; }

# Source the configuration.
[[ -f /etc/cya/cya.conf ]]     && . /etc/cya/cya.conf           # system-wide config file
[[ -f "$HOME/.cya/cya.conf" ]] && . "$HOME/.cya/cya.conf"       # per-user config file

# Make these available if the user hasn't overridden them
type -t duplicity-ex-snap >/dev/null || duplicity-ex-snap() { "$CYA_DIR/lib/duplicity-ex-snap" "$@"; }
type -t duplicity-ex      >/dev/null || duplicity-ex()      { "$CYA_DIR/lib/duplicity-ex" "$@"; }

backup()
{
	(
		set -e

		# don't let two backups run at the same time
		flock --nonblock 200 || { echo "Backup already in progress. Exiting."; exit 1; }

		# save the users from themselves; check that /etc/cya, /etc/cya/backup and the private SSH keys are
		# not group or world accessible
		for CONF in /etc/cya/cya.conf "$HOME/.cya/cya.conf"; do
			if [[ -f $CONF ]]; then
				GOPERMS=$(stat -c'%A' "$CONF" | cut -b 5-10)
				[[ $GOPERMS != "------" ]] && { echo "Permissions to $CONF incorrect (run 'chmod go-rwx $CONF')"; exit -1; }
				ETC_CYA_DIR=$(dirname "$CONF")
				GOPERMS=$(stat -c'%A' "$ETC_CYA_DIR" | cut -b 5-10)
				[[ $GOPERMS != "------" ]] && { echo "Permissions to $ETC_CYA_DIR incorrect (run 'chmod go-rwx $ETC_CYA_DIR')"; exit -1; }
				GOPERMS=$(stat -c'%A' "$SSHKEY" | cut -b 5-10)
				[[ $GOPERMS != "------" ]] && { echo "Permissions to $SSHKEY incorrect (run 'chmod go-rwx $SSHKEY')"; exit -1; }
			fi
		done
		# Test if it's OK to start
		START=$(ssh -i "$SSHKEY" "$DESTHOST" "test -d $DESTDIR/incoming/next && echo Y")
		[[ $START != "Y" ]] && exit 2;

		# Backup
		(
			# Close the lock file descriptor. Otherwise, if LVM is 
			# called by duplicity, it will complain about open descriptors.
			# Do it from a subshell so we don't release the lock
			exec 200>&-

			# Make sure cache directory isn't readable to anyone.
			# This is really a bug in duplicity.
			mkdir -p "$HOME/.cache/duplicity"
			chmod 700 "$HOME/.cache/duplicity"

			# Construct the --exclude line
			EXCLUSIONS=()
			if [[ ! -z $EXCLUDE ]]; then
				for DIR in "${EXCLUDE[@]}"; do EXCLUSIONS+=("--exclude" "$DIR"); done
			fi

			export PASSPHRASE="$BACKUP_ENCRYPTION_KEY"
			"$DUPLICITYCMD" \
				"$SOURCEDIR" \
				scp://"$DESTHOST"/"$DESTDIR"/incoming/next \
				--verbosity=error \
				--ssh-options="-oIdentityFile=$SSHKEY" \
				--asynchronous-upload --volsize=100 \
				"${EXCLUSIONS[@]}"
#				--ssh-backend pexpect \

			# Mark as finished
			ssh -i "$SSHKEY" "$DESTHOST" \
				mv "$DESTDIR"/incoming/next "$DESTDIR"/incoming/finished
		)

	) 200>/var/run/cya-backup
}

backup
