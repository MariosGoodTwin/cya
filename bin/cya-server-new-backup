#!/bin/bash
#
# cya-server-init <backup-name> <dropbox-user>
#

set -e

# Check arguments
[[ $# == 2 ]] || { echo "usage: $0 <backup-name> <dropbox-user>"; exit -1; }

BACKUPNAME="$1"
DROPUSER="$2"

# Find where we're installed
CYA_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../" && pwd )"
ARCHIVEDIR=/var/lib/cya/backups
HOSTNAME=$(hostname)
DROPGROUP=cya-drop

# Allow for overrides
[[ -f /etc/cya/server.conf ]] && . /etc/cya/server.conf

# Create dropbox user, if it doesn't exist
# Note: having shared dropbox users is discouraged
if ! id -u "$DROPUSER" >/dev/null 2>&1; then
	echo "Creating user $DROPUSER..."
	useradd "$DROPUSER"
else
	echo "User $DROPUSER already exists; re-using."
fi

#
# Make sure this user is in the cya-drop group.
#
# If cya-drop is set to allow password authentication
# in /etc/ssh/sshd_config, this will allow easy key setup
# for these users.
#
# # Add this to the _end_ of your /etc/ssh/sshd_config
# Match Group cya-drop
#    PasswordAuthentication yes
# 
if groups $DROPUSER | grep &>/dev/null '\b'$DROPGROUP'\b'; then
	echo "User $DROPUSER already in group $DROPGROUP."
else
	groupadd -f $DROPGROUP
	usermod -a -G $DROPGROUP "$DROPUSER"
	echo "Added $DROPUSER to group $DROPGROUP"
fi

# sanity checking before we create a new drop box
DROPHOME=$(getent passwd "$DROPUSER" | cut -d : -f 6)
[[ -d "$DROPHOME" ]] || { echo "Problem: $DROPHOME doesn't exist (?!)"; exit -1; }

DROPDIR="$DROPHOME/$BACKUPNAME"
[[ -d "$DROPDIR" ]] && { echo "$DROPDIR already exists. are you overwriting an existing backup?"; exit -1; }

DESTDIR="$ARCHIVEDIR/$BACKUPNAME"
[[ -d "$DESTDIR" ]] && { echo "$DESTDIR already exists. are you overwriting an existing backup?"; exit -1; }

# Initialize dropdir/destdir
echo -n "Initializing $DESTDIR..."
"$CYA_DIR/bin/cya-server-collect" --archive-user="$DROPUSER" --init "$DESTDIR"
echo "done."

# Move the dropbox dir (incoming) to its own user
echo -n "Moving dropbox to $DROPDIR..."
mv "$DESTDIR/incoming" "$DROPDIR"
ln -s "$DROPDIR" "$DESTDIR/incoming"
echo " done."

# set up a temporary password for this user. the client-side
# script will use it to log in and set up its key.
PASSWD=$(openssl rand -base64 20 | tr -d =)
echo "$PASSWD" | passwd --stdin "$DROPUSER"

echo "Now run"
echo "   cya-client new-backup $DROPUSER@$HOSTNAME $BACKUPNAME <dir_to_backup>"
echo "and use '$PASSWD' as password when prompted."
